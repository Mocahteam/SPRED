piece base, center, body, nose, feet0, feet1, feet2, clamps, turret, muzzle;
#include "springdefs.h"

#define SIG_AIM 1
#define SIG_DEPLOY 2
#define SIG_FIRE 4

static-var idle, deployed;

lua_SetAlphaThreshold() {
	return(0);
}

lua_SwitchToBug() {
	return 0;
}

Undeploy() {
	if (deployed) return 0; //mutex
	signal SIG_DEPLOY;
	set-signal-mask SIG_DEPLOY;
	deployed=1;
	while(!idle) sleep 30;
	
	var i;
	for (i = 5; i < 72 ; ++i) {
		//set ALPHA_THRESHOLD to i;
		call-script lua_SetAlphaThreshold(i);
		sleep 30;
	}
	hide clamps;
	hide turret;

	move body to y-axis [8] speed [64];
	turn body to x-axis 0 speed <360>;
	wait-for-move body along y-axis;

	move body to y-axis 0 speed [32];
	wait-for-move body along y-axis;

	show feet0;
	show feet1;
	show feet2;
	call-script lua_SwitchToBug();
}

SpecialAttack() {
	call-script Undeploy();
}

Create() {
	//set ALPHA_THRESHOLD to 1;
	call-script lua_SetAlphaThreshold(1);
	hide feet0;
	hide feet1;
	hide feet2;
	turn body to x-axis <180> now;
	move body to y-axis [-12] now;
	idle=1;
}

ResetAim() {
	sleep 3000;
	turn turret to y-axis 0 speed <180>;
	turn turret to x-axis 0 speed <180>;
}

AimFromWeapon1(p) {
	p=turret;
}

QueryWeapon1(p) {
	p=muzzle;
}

AimWeapon1(h,p) {
	if(deployed) return 0;
	signal SIG_AIM;
	set-signal-mask SIG_AIM | SIG_DEPLOY;
	start-script ResetAim();
	turn turret to y-axis h speed <180>;
	turn turret to x-axis 0-p speed <180>;
	wait-for-turn turret around y-axis;
	wait-for-turn turret around x-axis;
	return 1;
}

FireWeapon1() {
	signal SIG_FIRE;
	set-signal-mask SIG_FIRE;
	idle=0;
	sleep 5000;
	idle=1;
}